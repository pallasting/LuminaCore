name: ğŸš€ Release and Publish

on:
  push:
    tags:
      - 'v*'

jobs:
  create-github-release:
    name: ğŸ‰ GitHub Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ¦€ Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools
        pip install maturin
        
    - name: ğŸ”¨ Build Rust backend
      run: |
        cd lumina_kernel
        maturin build --release
        
    - name: ğŸ“¦ Build Python package
      run: |
        python -m build
        
    - name: ğŸ“Š Generate performance report
      id: performance
      run: |
        python benchmark_rust_vs_pytorch.py > performance_report.txt
        echo "performance_report<<EOF" >> $GITHUB_OUTPUT
        echo "$(cat performance_report.txt)" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ“‹ Extract changelog
      id: changelog
      run: |
        # ä»æœ€æ–°commitæå–changelogä¿¡æ¯
        CHANGELOG=$(git log --oneline -10)
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ‰ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ steps.changelog.outputs.changelog }}
        body: |
          ## ğŸŒŸ LuminaFlow ${{ github.ref_name }}
          
          ### ğŸš€ ä¸»è¦ç‰¹æ€§
          - âš¡ Rustèåˆç®—å­ - 5-10xæ€§èƒ½æå‡
          - ğŸ§  å™ªå£°æ„ŸçŸ¥è®­ç»ƒ - è§£å†³å…‰å­å™ªå£°é—®é¢˜
          - ğŸ”§ PyTorchåŸç”Ÿé›†æˆ - æ— ç¼å¼€å‘ä½“éªŒ
          - ğŸŒ å®Œæ•´å¼€æºç”Ÿæ€ - ç¤¾åŒºé©±åŠ¨å‘å±•
          
          ### ğŸ“Š æ€§èƒ½æŠ¥å‘Š
          ```
          ${{ steps.performance.outputs.performance_report }}
          ```
          
          ### ğŸ”— å¿«é€Ÿå¼€å§‹
          ```bash
          pip install lumina-flow
          ```
          
          ### ğŸ“š æ–‡æ¡£å’Œæ•™ç¨‹
          - ğŸ“– [æŠ€æœ¯æ–‡æ¡£](https://github.com/pallasting/LuminaCore/tree/v${{ github.ref_name }}/docs)
          - ğŸ““ [Colabæ•™ç¨‹](https://colab.research.google.com/github/pallasting/LuminaCore/blob/v${{ github.ref_name }}/notebooks/getting_started.ipynb)
          - ğŸ¤ [è´¡çŒ®æŒ‡å—](https://github.com/pallasting/LuminaCore/blob/main/CONTRIBUTING.md)
          - ğŸ’¬ [Discordç¤¾åŒº](https://discord.gg/j3UGaF7Y)
          
          ### ğŸ¯ åº”ç”¨åœºæ™¯
          - ğŸ¤– è‡ªä¸»é©¾é©¶ - å¾®ç§’çº§ç¯å¢ƒæ„ŸçŸ¥
          - ğŸ¥½ AR/VR - çœ¼é•œç«¯AIå¤„ç†
          - ğŸ  æ™ºèƒ½å®¶å±… - è®¾å¤‡ç«¯è¯­éŸ³è¯†åˆ«
          - âš¡ è¾¹ç¼˜è®¡ç®— - IoTæœ¬åœ°AIæ¨ç†
          
          ---
          **ğŸŒŸ Train once, survive noise. Build for speed of light.** âš¡
          
          *Made with â¤ï¸ by the LuminaFlow Team*
        files: |
          dist/*.whl
          dist/*.tar.gz
        draft: false
        prerelease: false
        
  publish-pypi:
    name: ğŸ“¦ Publish to PyPI
    runs-on: ubuntu-latest
    needs: create-github-release
    
    steps:
    - name: ğŸ›’ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools twine
        
    - name: ğŸ“¦ Download release artifacts
      uses: actions/download-artifact@v3
      with:
        name: python-wheels
        
    - name: ğŸ“¦ Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*
        
  publish-testpypi:
    name: ğŸ§ª Publish to TestPyPI
    runs-on: ubuntu-latest
    needs: create-github-release
    
    steps:
    - name: ğŸ›’ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools twine
        
    - name: ğŸ“¦ Download release artifacts
      uses: actions/download-artifact@v3
      with:
        name: python-wheels
        
    - name: ğŸ§ª Publish to TestPyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        TWINE_REPOSITORY_URL: https://test.pypi.org/legacy/
      run: |
        twine upload --repository-url https://test.pypi.org/legacy/ dist/*