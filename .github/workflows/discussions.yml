name: ğŸ¤ Auto Discussions Management

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened, closed]

jobs:
  discussion-manager:
    name: ğŸ¤ Discussions Manager
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›’ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install requests beautifulsoup4 markdown
        
    - name: ğŸ” Extract issue information
      id: extract_info
      run: |
        python <<'EOF'
import json
import re
        
# ä»äº‹ä»¶æ•°æ®ä¸­æå–ä¿¡æ¯
issue_data = """${{ toJson(github.event) }}"""
issue = json.loads(issue_data)

# æå–å…³é”®ä¿¡æ¯
issue_title = issue.get('title', '')
issue_body = issue.get('body', '')
issue_number = issue.get('number', 0)
issue_labels = [label.get('name', '') for label in issue.get('labels', [])]
author = issue.get('user', {}).get('login', '')
is_pr = issue.get('pull_request') is not None

# è¾“å‡ºç»“æ„åŒ–ä¿¡æ¯
output_info = {
    'title': issue_title,
    'body': issue_body,
    'number': issue_number,
    'labels': issue_labels,
    'author': author,
    'is_pr': is_pr
}

# ä¿å­˜åˆ°æ–‡ä»¶
with open('issue_info.json', 'w') as f:
    json.dump(output_info, f, indent=2)
    
print(f"âœ… Issue #{issue_number} ä¿¡æ¯å·²æå–")
        EOF
        
    - name: ğŸ¤ Generate discussion topics
      if: github.event_name == 'issues'
      run: |
        python <<'EOF'
import json
import requests
import os
import re

# è¯»å–issueä¿¡æ¯
with open('issue_info.json', 'r') as f:
    issue_info = json.load(f)

# GitHub APIé…ç½®
GITHUB_TOKEN = os.environ['GITHUB_TOKEN']
REPO_OWNER = 'pallasting'
REPO_NAME = 'LuminaCore'

def create_discussion(title, body, labels):
    """åˆ›å»ºGitHub Discussion"""
    headers = {
        'Authorization': f'token {GITHUB_TOKEN}',
        'Accept': 'application/vnd.github.v3+json'
    }
    
    data = {
        'title': title,
        'body': body,
        'category': 'General'
    }
    
    response = requests.post(
        f'https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}/discussions',
        headers=headers,
        json=data
    )
    
    if response.status_code == 201:
        discussion_url = response.json().get('html_url', '')
        print(f"âœ… Discussionåˆ›å»ºæˆåŠŸ: {discussion_url}")
        return discussion_url
    else:
        print(f"âŒ Discussionåˆ›å»ºå¤±è´¥: {response.status_code}")
        print(f"Response: {response.text}")
        return None

# æ ¹æ®Issueç±»å‹åˆ›å»ºä¸åŒç±»å‹çš„Discussions
def categorize_and_create():
    issue_info = json.loads(open('issue_info.json').read())
    title = issue_info['title']
    body = issue_info['body']
    number = issue_info['number']
    labels = issue_info['labels']
    author = issue_info['author']
    
    # ç§»é™¤ç‰¹æ®Šæ ‡ç­¾
    clean_labels = [label for label in labels if not label.startswith('auto-')]
    
    # åˆ†ç±»å¤„ç†
    if 'bug' in clean_labels:
        discussion_title = f"ğŸ› Bug #{number}: {title}"
        discussion_body = f"""## ğŸ› Bug Report
        
**Issue**: #{number} - {title}
**æŠ¥å‘Šè€…**: @{author}
**æ—¶é—´**: {issue_info.get('created_at', '')}

### ğŸ“‹ é—®é¢˜æè¿°
{body}

### ğŸ·ï¸ ç¯å¢ƒä¿¡æ¯
è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
- æ“ä½œç³»ç»Ÿï¼š
- Pythonç‰ˆæœ¬ï¼š
- LuminaFlowç‰ˆæœ¬ï¼š
- ç¡¬ä»¶é…ç½®ï¼ˆå¦‚æœç›¸å…³ï¼‰ï¼š

### ğŸ”„ é‡ç°æ­¥éª¤
1. 
2. 
3. 

### ğŸ¯ æœŸæœ›è¡Œä¸º
æè¿°æ­£ç¡®æƒ…å†µä¸‹åº”è¯¥å‘ç”Ÿä»€ä¹ˆã€‚

### ğŸ“Š å®é™…è¡Œä¸º
æè¿°å®é™…å‘ç”Ÿçš„æƒ…å†µã€‚

### ğŸ’¡ é¢å¤–ä¿¡æ¯
ä»»ä½•å…¶ä»–å¯èƒ½æœ‰åŠ©äºè°ƒè¯•çš„ä¿¡æ¯ã€‚

---

ğŸ·ï¸ **æ ‡ç­¾**: {', '.join(clean_labels)}
ğŸ¤– **è‡ªåŠ¨åˆ†ç±»**: Bug Report
ğŸ“š **å¤„ç†ä¼˜å…ˆçº§**: é«˜
        """
        
    elif 'enhancement' in clean_labels:
        discussion_title = f"âœ¨ Feature Request #{number}: {title}"
        discussion_body = f"""## âœ¨ Feature Request
        
**Issue**: #{number} - {title}
**æè®®è€…**: @{author}
**æ—¶é—´**: {issue_info.get('created_at', '')}

### ğŸ’¡ åŠŸèƒ½æè¿°
{body}

### ğŸ¯ è§£å†³çš„é—®é¢˜
æè¿°è¿™ä¸ªåŠŸèƒ½è¯·æ±‚è¦è§£å†³çš„å…·ä½“é—®é¢˜ã€‚

### ğŸ’¼ å»ºè®®è§£å†³æ–¹æ¡ˆ
æè¿°ä½ å¸Œæœ›çš„åŠŸèƒ½å®ç°æ–¹å¼ã€‚

### ğŸ“ˆ ä½¿ç”¨åœºæ™¯
æè¿°åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚

### ğŸ”— ç›¸å…³Issue
å¦‚æœæœ‰ç›¸å…³çš„é—®é¢˜æˆ–è®¨è®ºï¼Œè¯·æä¾›é“¾æ¥ã€‚

### ğŸ“‹ æŠ€æœ¯è€ƒé‡
è€ƒè™‘çš„æŠ€æœ¯é™åˆ¶æˆ–æŒ‘æˆ˜ï¼š
- æ€§èƒ½å½±å“
- å…¼å®¹æ€§è¦æ±‚  
- å®ç°å¤æ‚åº¦

---

ğŸ·ï¸ **æ ‡ç­¾**: {', '.join(clean_labels)}
ğŸ¤– **è‡ªåŠ¨åˆ†ç±»**: Feature Request
ğŸ“š **å¤„ç†ä¼˜å…ˆçº§**: ä¸­
        """
        
    elif 'question' in clean_labels:
        discussion_title = f"â“ Question #{number}: {title}"
        discussion_body = f"""## â“ Technical Question
        
**Issue**: #{number} - {title}
**æé—®è€…**: @{author}
**æ—¶é—´**: {issue_info.get('created_at', '')}

### ğŸ¤” é—®é¢˜æè¿°
{body}

### ğŸ’¡ å·²ç»å°è¯•çš„è§£å†³æ–¹æ¡ˆ
æè¿°ä½ å·²ç»å°è¯•è¿‡çš„è§£å†³æ–¹æ¡ˆã€‚

### ğŸ” ç›¸å…³ä»£ç æˆ–æ–‡æ¡£
å¦‚æœæœ‰ç›¸å…³ä»£ç ç‰‡æ®µæˆ–æ–‡æ¡£é“¾æ¥ï¼Œè¯·æä¾›ã€‚

### ğŸ¯ é¢„æœŸç­”æ¡ˆ
æè¿°ä½ æœŸæœ›å¾—åˆ°çš„å…·ä½“ç­”æ¡ˆã€‚

### ğŸ“š èƒŒæ™¯ä¿¡æ¯
ä½¿ç”¨LuminaFlowçš„å…·ä½“åœºæ™¯å’Œç›®çš„ã€‚

---

ğŸ·ï¸ **æ ‡ç­¾**: {', '.join(clean_labels)}
ğŸ¤– **è‡ªåŠ¨åˆ†ç±»**: Technical Question
ğŸ“š **å¤„ç†ä¼˜å…ˆçº§**: ä¸­
        """
        
    else:
        discussion_title = f"ğŸ’¬ General Discussion #{number}: {title}"
        discussion_body = f"""## ğŸ’¬ General Discussion
        
**Issue**: #{number} - {title}
**å‘èµ·è€…**: @{author}
**æ—¶é—´**: {issue_info.get('created_at', '')}

### ğŸ“‹ ä¸»é¢˜
{body}

### ğŸ’¬ è®¨è®ºå†…å®¹
è¿™é‡Œæ˜¯åˆ†äº«æƒ³æ³•ã€æå‡ºå»ºè®®æˆ–è¿›è¡ŒæŠ€æœ¯è®¨è®ºçš„åœ°æ–¹ã€‚

### ğŸ¯ è®¨è®ºç›®æ ‡
å¸Œæœ›è¾¾åˆ°ä»€ä¹ˆæ ·çš„è®¨è®ºç»“æœã€‚

---

ğŸ·ï¸ **æ ‡ç­¾**: {', '.join(clean_labels)}
ğŸ¤– **è‡ªåŠ¨åˆ†ç±»**: General Discussion
ğŸ“š **å¤„ç†ä¼˜å…ˆçº§**: ä½
        """
    
    # åˆ›å»ºDiscussion
    discussion_url = create_discussion(discussion_title, discussion_body, clean_labels)
    
    if discussion_url:
        # è‡ªåŠ¨å…³é—­åŸIssueå¹¶æ·»åŠ è¯„è®º
        close_comment = f"""ğŸ¤ è¿™ä¸ªIssueå·²è‡ªåŠ¨è½¬æ¢ä¸ºGitHub Discussionï¼Œä»¥ä¾¿æ›´å¥½çš„ç¤¾åŒºè®¨è®ºï¼

ğŸ’¬ **è®¨è®ºé“¾æ¥**: {discussion_url}

ğŸ·ï¸ **Issueå¤„ç†**:
- âœ… è½¬ç§»ä¸ºDiscussion: æ›´å¥½çš„è®¨è®ºä½“éªŒ
- ğŸ·ï¸ **æ ‡ç­¾ä¿ç•™**: åŸIssueæ ‡ç­¾ä¿æŒä¸å˜
- ğŸ“š **çŠ¶æ€åŒæ­¥**: åœ¨Discussionä¸­ç»§ç»­è·Ÿè¿›

æ„Ÿè°¢ä½ çš„è´¡çŒ®ï¼ğŸŒŸ
        """
        
        # è¿™é‡Œä¼šåœ¨åç»­æ­¥éª¤ä¸­è‡ªåŠ¨å…³é—­Issueå’Œæ·»åŠ è¯„è®º
        print(f"âœ… å·²å‡†å¤‡å…³é—­è¯„è®º")

if __name__ == "__main__":
    categorize_and_create()
        EOF
        
    - name: ğŸ”„ Close issue and add comment
      if: github.event_name == 'issues'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const issueInfo = JSON.parse(fs.readFileSync('issue_info.json', 'utf8'));
          
          github.rest.issues.createComment({
            issue_number: issueInfo.number,
            body: `ğŸ¤ è¿™ä¸ªIssueå·²è‡ªåŠ¨è½¬æ¢ä¸ºGitHub Discussionï¼Œä»¥ä¾¿æ›´å¥½çš„ç¤¾åŒºè®¨è®ºï¼

ğŸ’¬ **è®¨è®ºé“¾æ¥**: æŸ¥çœ‹ä¸Šæ–¹åˆ›å»ºçš„Discussioné“¾æ¥

ğŸ·ï¸ **Issueå¤„ç†**:
- âœ… è½¬ç§»ä¸ºDiscussion: æ›´å¥½çš„è®¨è®ºä½“éªŒ  
- ğŸ·ï¸ **æ ‡ç­¾ä¿ç•™**: åŸIssueæ ‡ç­¾ä¿æŒä¸å˜
- ğŸ“š **çŠ¶æ€åŒæ­¥**: åœ¨Discussionä¸­ç»§ç»­è·Ÿè¿›

æ„Ÿè°¢ä½ çš„è´¡çŒ®ï¼ğŸŒŸ`
          });
          
          console.log(`Closing issue #${issueInfo.number} after creating discussion`);
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
    - name: ğŸ¤– Update Discussion on PR close
      if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged
      run: |
        python <<'EOF'
import json
import requests
import os

# PRä¿¡æ¯
pr_data = """${{ toJson(github.event.pull_request) }}"""
pr = json.loads(pr_data)

if pr.get('merged'):
    title = pr.get('title', '')
    number = pr.get('number', 0)
    author = pr.get('user', {}).get('login', '')
    body = pr.get('body', '')
    
    # åœ¨PRä¸­æŸ¥æ‰¾å…³è”çš„Issueç¼–å·
    import re
    issue_numbers = re.findall(r'#{1,3}[0-9]+}', title + ' ' + body)
    
    if issue_numbers:
        for issue_num in issue_numbers:
            discussion_title = f"ğŸ‰ PR #{number} merged: è§£å†³äº†Issue #{issue_num}"
            discussion_body = f"""## ğŸ‰ Pull Request Merged!
            
### âœ… PRä¿¡æ¯
- **PR #{number}**: {title}
- **ä½œè€…**: @{author}
- **çŠ¶æ€**: âœ… å·²åˆå¹¶

### ğŸ”— å…³è”Issue
- **Issue #{issue_num}**: åŸé—®é¢˜å·²è§£å†³

### ğŸ’¬ è§£å†³æ–¹æ¡ˆ
{body[:200]}...

### ğŸ“‹ æŠ€æœ¯ç»†èŠ‚
åˆå¹¶çš„ä»£ç æ›´æ”¹è§£å†³äº†åŸæœ‰Issueä¸­çš„é—®é¢˜ã€‚

### ğŸ‰ æ„Ÿè°¢è´¡çŒ®
æ„Ÿè°¢ @{author} çš„å‡ºè‰²å·¥ä½œï¼è¿™ä¸ªPRä¸ºLuminaFlowé¡¹ç›®å¸¦æ¥äº†é‡è¦çš„æ”¹è¿›ã€‚

---

ğŸ·ï¸ **æ ‡ç­¾**: pull-request, merged, issue-closed
ğŸ¤– **è‡ªåŠ¨åˆ†ç±»**: PR Resolution
ğŸ“š **å¤„ç†ä¼˜å…ˆçº§**: é«˜

ç»§ç»­åœ¨ç›¸å…³çš„Discussionä¸­è®¨è®ºè¿™ä¸ªæ”¹è¿›ï¼
            """
            
            # åˆ›å»ºDiscussion
            GITHUB_TOKEN = os.environ['GITHUB_TOKEN']
            REPO_OWNER = 'pallasting'
            REPO_NAME = 'LuminaCore'
            
            headers = {
                'Authorization': f'token {GITHUB_TOKEN}',
                'Accept': 'application/vnd.github.v3+json'
            }
            
            data = {
                'title': discussion_title,
                'body': discussion_body,
                'category': 'General'
            }
            
            response = requests.post(
                f'https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}/discussions',
                headers=headers,
                json=data
            )
            
            if response.status_code == 201:
                discussion_url = response.json().get('html_url', '')
                print(f"âœ… Discussionåˆ›å»ºæˆåŠŸ: {discussion_url}")
            else:
                print(f"âŒ Discussionåˆ›å»ºå¤±è´¥: {response.status_code}")

EOF
        
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ§¹ Auto-assign labels
      if: github.event_name == 'issues'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const issueInfo = JSON.parse(fs.readFileSync('issue_info.json', 'utf8'));
          const labels = issueInfo.labels || [];
          
          // åŸºäºIssueå†…å®¹è‡ªåŠ¨æ·»åŠ æ ‡ç­¾
          const body = issueInfo.body || '';
          let autoLabels = [];
          
          // Bugæ£€æµ‹
          if (body.toLowerCase().includes('bug') || body.toLowerCase().includes('error') || labels.some(l => l.toLowerCase().includes('bug'))) {
            autoLabels.push('bug');
          }
          
          // åŠŸèƒ½è¯·æ±‚æ£€æµ‹
          if (body.toLowerCase().includes('feature') || body.toLowerCase().includes('enhancement') || labels.some(l => l.toLowerCase().includes('enhancement'))) {
            autoLabels.push('enhancement');
          }
          
          // é—®é¢˜æ£€æµ‹
          if (body.toLowerCase().includes('question') || body.toLowerCase().includes('help') || labels.some(l => l.toLowerCase().includes('question'))) {
            autoLabels.push('question');
          }
          
          // ä¼˜å…ˆçº§æ£€æµ‹
          if (body.toLowerCase().includes('urgent') || body.toLowerCase().includes('critical')) {
            autoLabels.push('high-priority');
          }
          
          if (autoLabels.length > 0) {
            // æ·»åŠ è‡ªåŠ¨æ ‡ç­¾
            github.rest.issues.addLabels({
              issue_number: issueInfo.number,
              labels: [...new Set([...labels, ...autoLabels])]
            });
            
            console.log(`Auto-assigned labels: ${autoLabels.join(', ')}`);
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
EOF
      with:
        script: |
          const fs = require('fs');
          const issueInfo = JSON.parse(fs.readFileSync('issue_info.json', 'utf8'));
          const labels = issueInfo.labels || [];
          
          // åŸºäºIssueå†…å®¹è‡ªåŠ¨æ·»åŠ æ ‡ç­¾
          const body = issueInfo.body || '';
          let autoLabels = [];
          
          // Bugæ£€æµ‹
          if (body.toLowerCase().includes('bug') || body.toLowerCase().includes('error') || labels.some(l => l.toLowerCase().includes('bug'))) {
            autoLabels.push('bug');
          }
          
          // åŠŸèƒ½è¯·æ±‚æ£€æµ‹
          if (body.toLowerCase().includes('feature') || body.toLowerCase().includes('enhancement') || labels.some(l => l.toLowerCase().includes('enhancement'))) {
            autoLabels.push('enhancement');
          }
          
          // é—®é¢˜æ£€æµ‹
          if (body.toLowerCase().includes('question') || body.toLowerCase().includes('help') || labels.some(l => l.toLowerCase().includes('question'))) {
            autoLabels.push('question');
          }
          
          // ä¼˜å…ˆçº§æ£€æµ‹
          if (body.toLowerCase().includes('urgent') || body.toLowerCase().includes('critical')) {
            autoLabels.push('high-priority');
          }
          
          if (autoLabels.length > 0) {
            // æ·»åŠ è‡ªåŠ¨æ ‡ç­¾
            github.rest.issues.addLabels({
              issue_number: issueInfo.number,
              labels: [...new Set([...labels, ...autoLabels])]
            });
            
            console.log(`Auto-assigned labels: ${autoLabels.join(', ')}`);
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
EOF